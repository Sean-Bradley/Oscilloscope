<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=1280" />
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />
    <title>X Y Oscilloscope by SeanWasEre Youtube</title>

    <style>
        BODY {
            margin: 0px;
            padding: 0px;
            font-family: Arial, Helvetica, sans-serif;
            background-color: white;
            color: black;
            font-size: 17px;
        }
    </style>


</head>
<body>
    <table>
        <tr>
            <td valign="top"><canvas id='scope' width=800 height=800></canvas></td>
            <td valign="top">
                <h1>X Y Oscilloscope</h1>
                <p>
                    Input Source:<br />
                    <select id="audioinput" onchange="changeInput(this.selectedIndex);">
                        <option>default</option>
                    </select>
                </p>
                <p><div id="inputError"></div></p>
                <p><div id="browserError" style="color:red;"></div></p>
                <p>Accepts live input from 'microphone' or 'stereo mix' sources.</p>
                <p>You will need to allow your browser to access your microphone when alerted.</p>
                <p>Left Input channel affects X and right input channel affects Y.</p>
                <p> Playing sine wave in left channel and cosine wave in right channel draws a circle.</p>
                <p>Written to work Windows 10 and Microsoft Edge Browser.</p>
                <p>On windows, right click speaker icon in task bar, and click 'Recording Devices'</p>
                <p>Choose 'Stereo Mix' as default device and make sure it's level is set to 100.</p>
                <p>If 'Stereo Mix' option is not visible, right click in devices area and tick 'Show Disabled Devices' and 'Show Disconnected Devices'</p>
                <p>If 'Stereo Mix' is still not visible, you may need to update the RealTek High Definition Audio drivers from the RealTek website.</p>
                <p>If all settings are correct then playing synth music from your desktop will produce patterns in the display.</p>
                <p>Flip X <input type="checkbox" onchange="changeflipX();" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Flip Y <input type="checkbox" onchange="changeflipY();" /></p>
                <p></p>
                <p>Written by <a href="https://youtube.com/seanwasere" target="_blank">SeanWasEre Youtube</a></p>

            </td>
        </tr>
    </table>


    <script lang="javascript">

        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        if (window.AudioContext == undefined) {
            document.getElementById('browserError').innerHTML = "Cannot find browser AudioContext object. Please try Microsoft Edge or Google Chrome.";
            document.getElementById('browserError').style.display = "block";

        }

        var context = new AudioContext();

        var currentStream;
        var gainNode;
        var mediaSource, mediaBuffer, remoteDestination;
        var analyser1;
        var analyser2;
        var splitter;

        var constraints =
            {
                audio: {
                    optional: [{ echoCancellation: false }]
                }
            };

        function changeInput() {
            if (!!window.stream) {
                window.stream.stop();
            }
            var audioSelect = document.getElementById("audioinput");
            var audioSource = audioSelect.value;
            constraints.audio.optional.push({ sourceId: audioSource });
            if (!navigator.getUserMedia) {
                navigator.getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
            }

            navigator.getUserMedia(constraints, gotStream, function (e) {
                document.getElementById('browserError').innerHTML = "Cannot find your input source.";
                document.getElementById('browserError').style.display = "block";
                document.getElementById('inputError').innerHTML = "Input source not found.";
                document.getElementById('audioinput').style.display = "none";
                document.getElementById('volume').style.display = "none";
                //document.getElementById('visualizer').style.display = "none";
            });
        }

        //try {
        //    MediaStreamTrack.getSources(gotSources);
        //} catch (e) {
        //    document.getElementById('browserError').innerHTML = "Cannot find MediaStreamTrack.gotSources(). Try Google Chrome on PC or Mac.";
        //}


        function gotSources(sourceInfos) {
            var audioSelect = document.getElementById("audioinput");
            while (audioSelect.firstChild) {
                audioSelect.removeChild(audioSelect.firstChild);
            }

            for (var i = 0; i != sourceInfos.length; ++i) {
                var sourceInfo = sourceInfos[i];
                if (sourceInfo.kind === 'audio') {
                    var option = document.createElement("option");
                    option.value = sourceInfo.id;
                    option.text = sourceInfo.label || 'input ' + (audioSelect.length + 1);
                    audioSelect.appendChild(option);
                }
            }
            audioSelect.onchange = changeInput;
        }

        function gotStream(stream) {
            try {
                mediaSource = context.createMediaStreamSource(stream);

                splitter.connect(analyser1, 0, 0);
                splitter.connect(analyser2, 1, 0);

                mediaSource.connect(splitter);

            } catch (e) {
                alert(e.message);
            }
        }



        analyser1 = context.createAnalyser();
        //analyser1.smoothingConstant = 1.0;
        analyser1.fftSize = 16384;

        analyser2 = context.createAnalyser();
        //analyser2.smoothingConstant = 1.0;
        analyser2.fftSize = 16384;

        splitter = context.createChannelSplitter();

        var ctx = document.getElementById('scope').getContext('2d');
        var width = ctx.canvas.width;
        var height = ctx.canvas.height;
        var canvasData = ctx.getImageData(0, 0, width, height);
        var canvasBlankData = ctx.getImageData(0, 0, width, height);

        var flipX = false;
        var flipY = false;
        var scaleX = 3;
        var scaleY = 3;

        function drawScope() {

            var timeData1 = new Uint8Array(analyser1.frequencyBinCount);
            var timeData2 = new Uint8Array(analyser2.frequencyBinCount);

            analyser1.getByteTimeDomainData(timeData1);
            analyser2.getByteTimeDomainData(timeData2);

            ctx.fillStyle = 'rgba(0, 0, 0, .1)';
            ctx.fillRect(0, 0, width, height);

            ctx.beginPath();
            //ctx.stroke();
            ctx.lineWidth = 1;
            ctx.strokeStyle = 'rgb(0, 128, 255)';
            ctx.beginPath();
            //ctx.moveTo(lastX, lastY);

            // No buffer overrun protection
            //while (timeData[risingEdge++] - 128 > 0 && risingEdge <= width);
            //if (risingEdge >= width) risingEdge = 0;

            //while (timeData[risingEdge++] - 128 < edgeThreshold && risingEdge <= width);
            //if (risingEdge >= width) risingEdge = 0;
            if (flipX && flipY) {
                for (var x = 0; x < timeData1.length; x++) {
                    ctx.lineTo(width - timeData1[x] * scaleX, timeData2[x] * scaleY);
                }
            } else if (flipX && !flipY) {
                for (var x = 0; x < timeData1.length; x++) {
                    ctx.lineTo(width - timeData1[x] * scaleX, height - timeData2[x] * scaleY);
                }
            } else if (!flipX && flipY) {
                for (var x = 0; x < timeData1.length; x++) {
                    ctx.lineTo(timeData1[x] * scaleX, timeData2[x] * scaleY);
                }
            } else {
                for (var x = 0; x < timeData1.length; x++) {
                    ctx.lineTo(timeData1[x] * scaleX, height - timeData2[x] * scaleY);

                    //var index = (parseInt(timeData1[x] * scaling) + parseInt(height - timeData2[x] * scaling) * width) * 4;

                    //canvasData.data[index + 0] = 0;
                    //canvasData.data[index + 1] = 200;
                    //canvasData.data[index + 2] = 0;
                    //canvasData.data[index + 3] = 255;
                }
            }

            //ctx.putImageData(canvasData, 0, 0);

            //lastX = width - timeData1[timeData1.length - 1] * scaling;
            //lastY = height - timeData2[timeData2.length - 1] * scaling;

            ctx.stroke();
        }

        function draw() {
            drawScope();

            requestAnimationFrame(draw);
        }

        changeInput();
        draw();

        function changeflipX(e) {
            flipX = !flipX;
        }
        function changeflipY(e) {
            flipY = !flipY;
        }

    </script>
</body>
</html>
